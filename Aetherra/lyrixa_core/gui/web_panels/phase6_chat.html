<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyrixa AI Chat Interface</title>
    <style>
        /* Phase 6 Chat Interface Styles */

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 600px;
            background: linear-gradient(135deg, var(--lyrixa-bg-start, rgba(0, 20, 40, 0.95)), var(--lyrixa-bg-end, rgba(0, 40, 80, 0.9)));
            border-radius: calc(var(--lyrixa-border-radius, 8px) * 2);
            overflow: hidden;
            border: 1px solid var(--lyrixa-primary, #00ff88);
            box-shadow: 0 12px 40px rgba(0, 255, 136, 0.2);
        }

        .chat-header {
            background: rgba(0, 40, 80, 0.8);
            padding: 15px 20px;
            border-bottom: 1px solid var(--lyrixa-primary, #00ff88);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-title h2 {
            color: var(--lyrixa-primary, #00ff88);
            margin: 0;
            font-size: 1.3em;
            font-weight: var(--lyrixa-heading-weight, 600);
        }

        .lyrixa-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--lyrixa-primary, #00ff88), var(--lyrixa-secondary, #0080ff));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            animation: pulse var(--lyrixa-animation-speed, 1)s infinite alternate;
        }

        .personality-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--lyrixa-secondary, #0080ff);
        }

        .emotion-badge {
            background: rgba(0, 255, 136, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid var(--lyrixa-primary, #00ff88);
            font-size: 0.8em;
            text-transform: capitalize;
        }

        .energy-bar {
            width: 40px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--lyrixa-secondary, #0080ff), var(--lyrixa-primary, #00ff88));
            transition: width 0.5s ease;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
        }

        .message.ai .message-avatar {
            background: radial-gradient(circle, var(--lyrixa-primary, #00ff88), var(--lyrixa-secondary, #0080ff));
            color: rgba(0, 20, 40, 0.9);
            animation: avatarPulse var(--lyrixa-animation-speed, 1)s infinite alternate;
        }

        .message-content {
            flex: 1;
            max-width: 70%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: calc(var(--lyrixa-border-radius, 8px) * 2);
            position: relative;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.3), rgba(53, 122, 189, 0.2));
            border: 1px solid rgba(74, 144, 226, 0.5);
            color: #e1f5fe;
        }

        .message.ai .message-bubble {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 128, 255, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--lyrixa-primary, #00ff88);
        }

        .message-metadata {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            font-size: 0.75em;
            opacity: 0.7;
        }

        .message.user .message-metadata {
            justify-content: flex-end;
            color: #b3d9ff;
        }

        .message.ai .message-metadata {
            color: var(--lyrixa-secondary, #0080ff);
        }

        .confidence-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .confidence-bar {
            width: 30px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--lyrixa-primary, #00ff88);
            transition: width 0.3s ease;
        }

        .processing-time {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .emotional-context {
            background: rgba(0, 255, 136, 0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(0, 255, 136, 0.3);
            background: rgba(0, 30, 60, 0.8);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 40, 80, 0.6);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: calc(var(--lyrixa-border-radius, 8px) * 2);
            padding: 12px 16px;
            color: var(--lyrixa-primary, #00ff88);
            font-size: 0.95em;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--lyrixa-primary, #00ff88);
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.3);
            background: rgba(0, 40, 80, 0.8);
        }

        .chat-input::placeholder {
            color: rgba(0, 255, 136, 0.5);
        }

        .send-button {
            background: linear-gradient(135deg, var(--lyrixa-primary, #00ff88), var(--lyrixa-secondary, #0080ff));
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(0, 20, 40, 0.9);
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.4);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: calc(var(--lyrixa-border-radius, 8px) * 2);
            margin: 10px 0;
            animation: fadeInOut 2s infinite;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--lyrixa-primary, #00ff88);
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .context-panel {
            background: rgba(0, 20, 40, 0.8);
            border-top: 1px solid rgba(0, 255, 136, 0.3);
            padding: 12px 20px;
            font-size: 0.8em;
            color: var(--lyrixa-secondary, #0080ff);
        }

        .context-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-panel-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .personality-stats {
            display: flex;
            gap: 15px;
            font-size: 0.75em;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-bar {
            width: 25px;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            background: var(--lyrixa-primary, #00ff88);
            transition: width 0.5s ease;
        }

        /* Animations */
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }

        @keyframes avatarPulse {
            from {
                box-shadow: 0 0 8px rgba(0, 255, 136, 0.3);
                transform: scale(1);
            }
            to {
                box-shadow: 0 0 16px rgba(0, 255, 136, 0.6);
                transform: scale(1.02);
            }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 40, 80, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 136, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                border-radius: 0;
                height: 100vh;
            }

            .message-content {
                max-width: 85%;
            }

            .personality-stats {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-title">
                <div class="lyrixa-avatar">🌌</div>
                <h2>Chat with Lyrixa</h2>
            </div>
            <div class="personality-indicator">
                <span class="emotion-badge" id="emotion-badge">neutral</span>
                <div class="energy-bar">
                    <div class="energy-fill" id="energy-fill" style="width: 70%"></div>
                </div>
            </div>
        </div>

        <!-- Context Panel -->
        <div class="context-panel">
            <div class="context-info">
                <div class="current-panel-info">
                    <span>📍 Current Panel: <strong id="current-panel">Chat</strong></span>
                </div>
                <div class="personality-stats">
                    <div class="stat-item">
                        <span>Focus:</span>
                        <div class="stat-bar">
                            <div class="stat-fill" id="focus-fill" style="width: 80%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span>Creativity:</span>
                        <div class="stat-bar">
                            <div class="stat-fill" id="creativity-fill" style="width: 60%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span>Social:</span>
                        <div class="stat-bar">
                            <div class="stat-fill" id="social-fill" style="width: 85%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chat-messages">
            <!-- Welcome Message -->
            <div class="message ai">
                <div class="message-avatar">🌌</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div>Hello! I'm Lyrixa, your AI operating system. My interface adapts to my emotional state and your preferences. I can see you're exploring the chat feature - that's wonderful! How can I help you today?</div>
                    </div>
                    <div class="message-metadata">
                        <span class="timestamp">Just now</span>
                        <div class="confidence-indicator">
                            <span>Confidence:</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 95%"></div>
                            </div>
                        </div>
                        <div class="emotional-context">welcoming</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator (hidden by default) -->
        <div class="typing-indicator" id="typing-indicator" style="display: none;">
            <div class="lyrixa-avatar" style="width: 24px; height: 24px; font-size: 0.9em;">🌌</div>
            <span>Lyrixa is thinking</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea
                    class="chat-input"
                    id="chat-input"
                    placeholder="Type your message to Lyrixa... (Press Enter to send)"
                    rows="1"></textarea>
                <button class="send-button" id="send-button">
                    ➤
                </button>
            </div>
        </div>
    </div>

    <script>
        // Phase 6 Chat Interface JavaScript

        class LyrixaChatInterface {
            constructor() {
                this.messages = [];
                this.isTyping = false;
                this.personalityState = {
                    emotional_state: 'neutral',
                    energy_level: 0.7,
                    focus_level: 0.8,
                    creativity_level: 0.6,
                    social_engagement: 0.8
                };

                this.initializeElements();
                this.setupEventListeners();
                this.setupWebChannel();
                this.startPersonalityUpdates();
            }

            initializeElements() {
                this.chatMessages = document.getElementById('chat-messages');
                this.chatInput = document.getElementById('chat-input');
                this.sendButton = document.getElementById('send-button');
                this.typingIndicator = document.getElementById('typing-indicator');
                this.emotionBadge = document.getElementById('emotion-badge');
                this.energyFill = document.getElementById('energy-fill');
                this.currentPanel = document.getElementById('current-panel');
                this.focusFill = document.getElementById('focus-fill');
                this.creativityFill = document.getElementById('creativity-fill');
                this.socialFill = document.getElementById('social-fill');
            }

            setupEventListeners() {
                // Send message on Enter (but allow Shift+Enter for new lines)
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Auto-resize textarea
                this.chatInput.addEventListener('input', () => {
                    this.chatInput.style.height = 'auto';
                    this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 120) + 'px';
                });

                // Send button click
                this.sendButton.addEventListener('click', () => {
                    this.sendMessage();
                });
            }

            setupWebChannel() {
                // Setup Qt WebChannel communication
                if (typeof qt !== 'undefined' && qt.webChannelTransport) {
                    new QWebChannel(qt.webChannelTransport, (channel) => {
                        this.bridge = channel.objects.bridge;
                        this.personalityManager = channel.objects.personality_manager;

                        // Listen for personality updates
                        if (this.personalityManager) {
                            this.personalityManager.personality_changed.connect((personalityJson) => {
                                this.updatePersonalityDisplay(JSON.parse(personalityJson));
                            });

                            this.personalityManager.chat_message.connect((messageJson) => {
                                this.handleChatMessage(JSON.parse(messageJson));
                            });
                        }

                        console.log('Chat interface connected to Qt backend');
                    });
                } else {
                    console.log('Running in standalone mode - using mock responses');
                    this.setupMockMode();
                }
            }

            setupMockMode() {
                // For testing without Qt backend
                this.personalityManager = {
                    process_chat_sync: (message) => {
                        return this.generateMockResponse(message);
                    }
                };
            }

            generateMockResponse(message) {
                const responses = [
                    "That's a fascinating perspective! My current emotional state is helping me process your thoughts.",
                    "I appreciate you sharing that with me. My interface is adapting as we speak to better serve our conversation.",
                    "Let me think about that... My cognitive processes are working through the implications of what you've said.",
                    "I'm feeling quite engaged by our discussion! You can see my emotional state reflected in the interface colors.",
                    "That's an excellent question. My analytical processes are helping me formulate a thoughtful response."
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message || this.isTyping) return;

                // Add user message to UI
                this.addMessage({
                    content: message,
                    is_user: true,
                    timestamp: new Date(),
                    confidence: 1.0
                });

                // Clear input
                this.chatInput.value = '';
                this.chatInput.style.height = 'auto';

                // Show typing indicator
                this.showTypingIndicator();

                try {
                    // Send to backend
                    let response;
                    if (this.personalityManager && this.personalityManager.process_chat_sync) {
                        response = this.personalityManager.process_chat_sync(message);
                    } else {
                        // Fallback to mock response
                        await this.delay(1000 + Math.random() * 2000); // Simulate processing time
                        response = this.generateMockResponse(message);
                    }

                    // Hide typing indicator
                    this.hideTypingIndicator();

                    // Add AI response
                    this.addMessage({
                        content: response,
                        is_user: false,
                        timestamp: new Date(),
                        confidence: 0.8 + Math.random() * 0.2,
                        emotional_context: this.personalityState.emotional_state,
                        processing_time: 1.2 + Math.random() * 2
                    });

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.hideTypingIndicator();
                    this.addMessage({
                        content: "I apologize, but I'm having trouble processing that request right now. Let me recalibrate my systems.",
                        is_user: false,
                        timestamp: new Date(),
                        confidence: 0.3,
                        emotional_context: 'neutral'
                    });
                }
            }

            addMessage(messageData) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${messageData.is_user ? 'user' : 'ai'}`;

                const avatar = messageData.is_user ? '👤' : '🌌';
                const confidence = messageData.confidence || 1.0;
                const timestamp = this.formatTimestamp(messageData.timestamp);

                let metadataHtml = `<span class="timestamp">${timestamp}</span>`;

                if (!messageData.is_user) {
                    metadataHtml += `
                        <div class="confidence-indicator">
                            <span>Confidence:</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                            </div>
                        </div>`;

                    if (messageData.emotional_context) {
                        metadataHtml += `<div class="emotional-context">${messageData.emotional_context}</div>`;
                    }

                    if (messageData.processing_time) {
                        metadataHtml += `
                            <div class="processing-time">
                                <span>⏱</span>
                                <span>${messageData.processing_time.toFixed(1)}s</span>
                            </div>`;
                    }
                }

                messageElement.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <div>${this.formatMessageContent(messageData.content)}</div>
                        </div>
                        <div class="message-metadata">
                            ${metadataHtml}
                        </div>
                    </div>
                `;

                this.chatMessages.appendChild(messageElement);
                this.scrollToBottom();

                // Store message
                this.messages.push(messageData);
            }

            formatMessageContent(content) {
                // Simple formatting for markdown-like syntax
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
            }

            formatTimestamp(timestamp) {
                const now = new Date();
                const diff = now - timestamp;

                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;

                return timestamp.toLocaleDateString();
            }

            showTypingIndicator() {
                this.isTyping = true;
                this.typingIndicator.style.display = 'flex';
                this.sendButton.disabled = true;
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.isTyping = false;
                this.typingIndicator.style.display = 'none';
                this.sendButton.disabled = false;
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                }, 100);
            }

            updatePersonalityDisplay(personalityState) {
                this.personalityState = personalityState;

                // Update emotion badge
                this.emotionBadge.textContent = personalityState.emotional_state;

                // Update energy bar
                this.energyFill.style.width = `${personalityState.energy_level * 100}%`;

                // Update personality stats
                this.focusFill.style.width = `${personalityState.focus_level * 100}%`;
                this.creativityFill.style.width = `${personalityState.creativity_level * 100}%`;
                this.socialFill.style.width = `${personalityState.social_engagement * 100}%`;

                console.log('Personality updated:', personalityState);
            }

            handleChatMessage(messageData) {
                // Handle incoming chat messages from the backend
                if (messageData.ai_response) {
                    this.hideTypingIndicator();
                    this.addMessage(messageData.ai_response);
                }

                if (messageData.personality_state) {
                    this.updatePersonalityDisplay(messageData.personality_state);
                }
            }

            startPersonalityUpdates() {
                // Simulate personality updates for demo purposes
                setInterval(() => {
                    if (!this.personalityManager) {
                        // Mock personality evolution
                        this.personalityState.energy_level = Math.max(0.3, Math.min(1.0,
                            this.personalityState.energy_level + (Math.random() - 0.5) * 0.1));
                        this.personalityState.focus_level = Math.max(0.2, Math.min(1.0,
                            this.personalityState.focus_level + (Math.random() - 0.5) * 0.05));
                        this.personalityState.creativity_level = Math.max(0.2, Math.min(1.0,
                            this.personalityState.creativity_level + (Math.random() - 0.5) * 0.08));

                        this.updatePersonalityDisplay(this.personalityState);
                    }
                }, 5000);
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize chat interface when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.lyrixaChat = new LyrixaChatInterface();
        });

        // Expose to Qt WebChannel
        window.updateCurrentPanel = function(panelName) {
            const panelElement = document.getElementById('current-panel');
            if (panelElement) {
                panelElement.textContent = panelName;
            }
        };

        window.updatePersonality = function(personalityJson) {
            if (window.lyrixaChat) {
                window.lyrixaChat.updatePersonalityDisplay(JSON.parse(personalityJson));
            }
        };
    </script>
</body>
</html>
